name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Resolve tag
        run: |
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="$(git describe --tags --abbrev=0)"
          fi
          echo "RELEASE_TAG=${TAG}" >> "$GITHUB_ENV"
          echo "RELEASE_VERSION=${TAG#v}" >> "$GITHUB_ENV"

      - name: Build
        run: ./build.sh

      - name: Package
        run: ditto -c -k --sequesterRsrc --keepParent dist/AudioPriority.app AudioPriority.zip

      - name: Compute checksum
        run: echo "ASSET_SHA256=$(shasum -a 256 AudioPriority.zip | awk '{print $1}')" >> "$GITHUB_ENV"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: AudioPriority.zip

      - name: Update Homebrew tap
        env:
          TAP_REPO: mateusbadalotti/homebrew-audio-priority
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          if [ -z "$TAP_TOKEN" ]; then
            echo "Missing HOMEBREW_TAP_GITHUB_TOKEN secret."
            exit 1
          fi

          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${TAP_REPO}.git" tap
          if git -C tap rev-parse --verify master >/dev/null 2>&1; then
            git -C tap checkout master
          else
            git -C tap checkout -b master
          fi
          mkdir -p tap/Casks

          VERSION="${RELEASE_VERSION}"
          URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/AudioPriority.zip"

          cat > tap/Casks/audio-priority.rb <<RUBY
          cask "audio-priority" do
            version "${VERSION}"
            sha256 "${ASSET_SHA256}"

            url "${URL}"
            name "Audio Priority"
            desc "Menu bar app that manages audio device priority"
            homepage "https://badalotti.dev/audio-priority"

            auto_updates false
            depends_on macos: ">= :sonoma"

            app "AudioPriority.app"
          end
          RUBY

          cd tap
          git add Casks/audio-priority.rb
          git commit -m "Update audio-priority to ${VERSION}" || echo "No changes to commit."
          git push -u origin master
